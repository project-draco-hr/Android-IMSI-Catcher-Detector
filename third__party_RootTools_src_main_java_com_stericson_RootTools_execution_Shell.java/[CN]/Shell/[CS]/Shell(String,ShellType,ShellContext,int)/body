{
  RootTools.log("Starting shell: " + cmd);
  RootTools.log("Context: " + shellContext.getValue());
  RootTools.log("Timeout: " + shellTimeout);
  this.shellType=shellType;
  this.shellTimeout=shellTimeout > 0 ? shellTimeout : this.shellTimeout;
  this.shellContext=shellContext;
  if (this.shellContext == ShellContext.NORMAL) {
    this.proc=new ProcessBuilder(cmd).redirectErrorStream(true).start();
  }
 else {
    this.proc=new ProcessBuilder(cmd,"--context " + this.shellContext.getValue()).redirectErrorStream(true).start();
  }
  this.in=new BufferedReader(new InputStreamReader(this.proc.getInputStream(),"UTF-8"));
  this.out=new OutputStreamWriter(this.proc.getOutputStream(),"UTF-8");
  Worker worker=new Worker(this);
  worker.start();
  try {
    worker.join(this.shellTimeout);
    if (worker.exit == -911) {
      try {
        this.proc.destroy();
      }
 catch (      Exception e) {
      }
      closeQuietly(this.in);
      closeQuietly(this.out);
      throw new TimeoutException(this.error);
    }
 else     if (worker.exit == -42) {
      try {
        this.proc.destroy();
      }
 catch (      Exception e) {
      }
      closeQuietly(this.in);
      closeQuietly(this.out);
      throw new RootDeniedException("Root Access Denied");
    }
 else {
      Thread si=new Thread(this.input,"Shell Input");
      si.setPriority(Thread.NORM_PRIORITY);
      si.start();
      Thread so=new Thread(this.output,"Shell Output");
      so.setPriority(Thread.NORM_PRIORITY);
      so.start();
    }
  }
 catch (  InterruptedException ex) {
    worker.interrupt();
    Thread.currentThread().interrupt();
    throw new TimeoutException();
  }
}
