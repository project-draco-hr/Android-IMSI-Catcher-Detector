{
  if (Build.VERSION.SDK_INT > 16) {
    DeviceApi17.loadCellInfo(tm,mDevice);
  }
  if (!mDevice.mCell.isValid()) {
    CellLocation cellLocation=tm.getCellLocation();
    if (cellLocation != null) {
switch (mDevice.getPhoneID()) {
case TelephonyManager.PHONE_TYPE_NONE:
case TelephonyManager.PHONE_TYPE_SIP:
case TelephonyManager.PHONE_TYPE_GSM:
        GsmCellLocation gsmCellLocation=(GsmCellLocation)cellLocation;
      mDevice.mCell.setCID(gsmCellLocation.getCid());
    mDevice.mCell.setLAC(gsmCellLocation.getLac());
  mDevice.mCell.setPSC(gsmCellLocation.getPsc());
break;
case TelephonyManager.PHONE_TYPE_CDMA:
CdmaCellLocation cdmaCellLocation=(CdmaCellLocation)cellLocation;
mDevice.mCell.setCID(cdmaCellLocation.getBaseStationId());
mDevice.mCell.setLAC(cdmaCellLocation.getNetworkId());
mDevice.mCell.setSID(cdmaCellLocation.getSystemId());
mDevice.mCell.setMNC(cdmaCellLocation.getSystemId());
break;
}
}
}
if (loc != null && (loc.getLatitude() != 0.0 && loc.getLongitude() != 0.0)) {
mDevice.mCell.setLon(loc.getLongitude());
mDevice.mCell.setLat(loc.getLatitude());
mDevice.mCell.setSpeed(loc.getSpeed());
mDevice.mCell.setAccuracy(loc.getAccuracy());
mDevice.mCell.setBearing(loc.getBearing());
mDevice.setLastLocation(loc);
SharedPreferences.Editor prefsEditor;
prefsEditor=prefs.edit();
prefsEditor.putString(context.getString(R.string.data_last_lat_lon),String.valueOf(loc.getLatitude()) + ":" + String.valueOf(loc.getLongitude()));
prefsEditor.apply();
if (mTrackingCell) {
dbHelper.insertBTS(mDevice.mCell);
}
}
}
