{
  GeoLocation loc=null;
  Location location=lm.getLastKnownLocation(LocationManager.GPS_PROVIDER);
  if (location != null && (location.getLatitude() != 0.0 && location.getLongitude() != 0.0)) {
    TruncatedLocation TruncatedLocation=new TruncatedLocation(location);
    loc=GeoLocation.fromDegrees(TruncatedLocation.getLatitude(),TruncatedLocation.getLongitude());
  }
 else {
    location=lm.getLastKnownLocation(LocationManager.NETWORK_PROVIDER);
    if (location != null && (location.getLatitude() != 0.0 && location.getLongitude() != 0.0)) {
      TruncatedLocation TruncatedLocation=new TruncatedLocation(location);
      loc=GeoLocation.fromDegrees(TruncatedLocation.getLatitude(),TruncatedLocation.getLongitude());
    }
 else {
      String coords=prefs.getString(context.getString(R.string.data_last_lat_lon),null);
      if (coords != null) {
        String[] coord=coords.split(":");
        loc=GeoLocation.fromDegrees(Double.valueOf(coord[0]),Double.valueOf(coord[1]));
      }
 else {
        try {
          Cell cell=context.getCell();
          if (cell != null) {
            Log.d("location","Looking up MCC " + cell.getMCC());
            AIMSICDDbAdapter mDbHelper=new AIMSICDDbAdapter(context);
            double[] defLoc=mDbHelper.getDefaultLocation(cell.getMCC());
            loc=GeoLocation.fromDegrees(defLoc[0],defLoc[1]);
          }
        }
 catch (        Exception e) {
          Log.e("location","Unable to get location from MCC",e);
        }
      }
    }
  }
  if (loc != null)   Log.i("location","Last known location " + loc.toString());
  return loc;
}
