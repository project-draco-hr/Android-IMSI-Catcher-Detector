{
  if (mDevice.isBetterLocation(loc,mDevice.getLastLocation())) {
    if (Build.VERSION.SDK_INT > 16) {
      List<CellInfo> cellinfolist=tm.getAllCellInfo();
      if (cellinfolist != null) {
        for (        final CellInfo cellinfo : cellinfolist) {
          if (cellinfo instanceof CellInfoGsm) {
            final CellSignalStrengthGsm signalStrengthGsm=((CellInfoGsm)cellinfo).getCellSignalStrength();
            final CellIdentityGsm identityGsm=((CellInfoGsm)cellinfo).getCellIdentity();
            if (identityGsm != null) {
              mDevice.setCellID(identityGsm.getCid());
              mDevice.setLAC(identityGsm.getLac());
              mDevice.setMcc(identityGsm.getMcc());
              mDevice.setMnc(identityGsm.getMnc());
            }
            if (signalStrengthGsm != null) {
              mDevice.setSignalInfo(signalStrengthGsm.getDbm());
            }
            break;
          }
 else           if (cellinfo instanceof CellInfoCdma) {
            final CellSignalStrengthCdma signalStrengthCdma=((CellInfoCdma)cellinfo).getCellSignalStrength();
            final CellIdentityCdma identityCdma=((CellInfoCdma)cellinfo).getCellIdentity();
            if (identityCdma != null) {
              mDevice.setCellID(identityCdma.getBasestationId());
              mDevice.setLAC(identityCdma.getNetworkId());
            }
            if (signalStrengthCdma != null) {
              mDevice.setSignalInfo(signalStrengthCdma.getDbm());
            }
            break;
          }
 else           if (cellinfo instanceof CellInfoLte) {
            final CellSignalStrengthLte signalStrengthLte=((CellInfoLte)cellinfo).getCellSignalStrength();
            final CellIdentityLte identityLte=((CellInfoLte)cellinfo).getCellIdentity();
            if (identityLte != null) {
              mDevice.setCellID(identityLte.getPci());
              mDevice.setLAC(identityLte.getTac());
              mDevice.setMcc(identityLte.getMcc());
              mDevice.setMnc(identityLte.getMnc());
            }
            if (signalStrengthLte != null) {
              mDevice.setSignalInfo(signalStrengthLte.getDbm());
            }
            break;
          }
 else           if (cellinfo instanceof CellInfoWcdma) {
            final CellSignalStrengthWcdma signalStrengthWcdma=((CellInfoWcdma)cellinfo).getCellSignalStrength();
            final CellIdentityWcdma identityWcdma=((CellInfoWcdma)cellinfo).getCellIdentity();
            if (identityWcdma != null) {
              mDevice.setCellID(identityWcdma.getCid());
              mDevice.setLAC(identityWcdma.getLac());
              mDevice.setMcc(identityWcdma.getMcc());
              mDevice.setMnc(identityWcdma.getMnc());
            }
            if (signalStrengthWcdma != null) {
              mDevice.setSignalInfo(signalStrengthWcdma.getDbm());
            }
            break;
          }
        }
      }
 else {
        CellLocation cellLocation=tm.getCellLocation();
        if (cellLocation != null) {
switch (mDevice.getPhoneID()) {
case TelephonyManager.PHONE_TYPE_GSM:
            GsmCellLocation gsmCellLocation=(GsmCellLocation)cellLocation;
          mDevice.setCellID(gsmCellLocation.getCid());
        mDevice.setLAC(gsmCellLocation.getLac());
      break;
case TelephonyManager.PHONE_TYPE_CDMA:
    CdmaCellLocation cdmaCellLocation=(CdmaCellLocation)cellLocation;
  mDevice.setCellID(cdmaCellLocation.getBaseStationId());
mDevice.setLAC(cdmaCellLocation.getNetworkId());
}
}
}
}
if (loc != null && (loc.getLatitude() != 0.0 && loc.getLongitude() != 0.0)) {
mDevice.setLongitude(loc.getLongitude());
mDevice.setLatitude(loc.getLatitude());
mDevice.setLastLocation(loc);
mDevice.setSpeed(loc.getSpeed());
mDevice.setAccuracy(loc.getAccuracy());
mDevice.setBearing(loc.getBearing());
if (TrackingCell) {
dbHelper.open();
mDbResult=dbHelper.insertLocation(mDevice.getLac(),mDevice.getCellId(),mDevice.getNetID(),mDevice.getLatitude(),mDevice.getLongitude(),mDevice.getSignalInfo(),mDevice.getCellInfo());
mDbResult=dbHelper.insertCell(mDevice.getLac(),mDevice.getCellId(),mDevice.getNetID(),mDevice.getLatitude(),mDevice.getLongitude(),mDevice.getSignalInfo(),mDevice.getMCC(),mDevice.getMnc(),mDevice.getAccuracy(),mDevice.getSpeed(),mDevice.getBearing(),mDevice.getNetworkTypeName(),SystemClock.currentThreadTimeMillis());
if (mDbResult == -1) {
Log.e(TAG,"Error writing to database");
}
}
}
}
}
